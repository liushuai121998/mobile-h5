$define(["wgt_util","jquery.formValidate","md5","jquery.message","laydate"],function(u,t,e,a,i,r){var x=function(e,a,t,i,r,n,s){var o={};o.request_url=t,o.url_param=i,o.requst_type=r||"GET";var d=encodeURIComponent(encodeURIComponent(JSON.stringify(o))),c=u.md5Sign(JSON.stringify(o));u.ajax({type:"POST",url:"/",async:s||void 0===s,data:{param:d,sign:c},success:function(t){n(t,e,a)},error:function(){console.log(e)}})};return{init:function(){var l=this._params,m=$compCl.getScope(l.id),h=(l.CorrectRequired&&l.CorrectRequired,l.DataFailed&&l.DataFailed,!0),v=!0,i='<div class="e_LoginPrompt p_LoginPrompt corlor_warning" data-ename="表单错误提示语"><i class="iconfont icon-error"></i><span class="text-error color_error">手机号码不能为空或格式不正确！</span></div>',g=!1;function _(t,e){e.removeClass("success").addClass("error"),e.find(".p_LoginPrompt").remove().end().append(i),e.find(".text-error").text(t.attr("data-error")),t.data("status",0)}function y(t,e,a){e.removeClass("success").addClass("error"),e.find(".p_LoginPrompt").remove().end().append(i),e.find(".text-error").text(a),t.data("status",0)}var C=function(t,e){e.removeClass("error").addClass("success"),e.find(".p_LoginPrompt").remove().end().append(i),e.find(".text-error").text(""),t.data("status",1)};function s(i){var t,e=i.val(),r=i.parent(),a=i.attr("name"),n=i.attr("data-type"),s=i.attr("data-subType"),o=(e.length,/^[1-9]\d{3}-(0[1-9]|1[0-2])-(0[1-9]|[1-2][0-9]|3[0-1])$/),d=i.attr("tit"),c=!1;if("true"==i.attr("data-required")?e&&""!=e.trim()?c=!0:(y(i,r,d+l.mp),h=!1):e&&""!=e.trim()?c=!0:((t=r).removeClass("error success"),t.find(".p_LoginPrompt").remove(),h=!1),c){if(C(i,r),1==n&&(2==s?/^[0-9]*$/.test(e)?C(i,r):(y(i,r,l.number),h=!1):3==s?/^\d+$/.test(e)?C(i,r):(y(i,r,l.correct+d+l.hm),h=!1):4==s?/^[0-9-()（）]{7,18}$/g.test(e)?C(i,r):(y(i,r,l.correct+d+l.hm),h=!1):5==s?/(^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$)/g.test(e)?C(i,r):(y(i,r,l.correctG+d),h=!1):6==s?o.test(e)?C(i,r):(y(i,r,l.correctG+d),h=!1):7==s&&(o.test(e)?C(i,r):(y(i,r,l.correctG+d),h=!1))),"captchas"==a){var p="/interactionApi/captcha/checkCaptcha",f={captchaId:m.find(".p_image img").attr("data-id"),code:e};x(m,l,p,{formData:f},"GET",function(t){if(!t.data||""===t.data)return _(i,r),void(h=!1);var e=JSON.parse(t.data);if("101"==(e=JSON.parse(t.data)).status){var a="1"==e.data.code;a?(g=!0,C(i,r)):(g=h=!1,_(i,r))}else _(i,r),h=!1})}if("phoneCode"==a||"mailCode"==a){p="/interactionApi/member/account/checkVerifyCode";var u="";u="phoneCode"==a?i.parents(".p_aaa").find(".p_PhoneBox input").val():i.parents(".p_aaa").find(".p_EmailBox input").val(),f={compType:l.id,verifyName:u,verifyType:"SMS",verifyValue:e},"mailCode"==a&&(f.verifyType="EMAIL"),x(m,l,p,f,"GET",function(t){if(!t.data||""===t.data)return _(i,r),void(v=h=!1);var e=JSON.parse(t.data);"101"==e.status?"2000"==e.data.status?(C(i,r),v=!0):(v=h=!1,_(i,r)):(_(i,r),h=!1)})}}return h}var t=function(i,t){var e={compId:t.id};x(i,t,"/interactionApi/captcha/getCaptcha",e,"CET",function(t){if(t.data&&""!==t.data){var e=JSON.parse(t.data);if("101"==e.status){var a=i.find(".p_image img");a.attr("src",e.data.imgSrc),a.attr("data-id",e.data.captchaId)}}})};t(m,l);var e,a=m.find(".p_image");a.off("click"),a.on("click",function(){t(m,l)}),(e=m).find(".p_date").each(function(){var t="#"+u(this).attr("id"),e=u(this);laydate.render({elem:t,done:function(t){s(e)}})}),e.find(".p_dateTime").each(function(){var t="#"+u(this).attr("id"),e=u(this);laydate.render({elem:t,type:"datetime",done:function(t){s(e)}})}),m.find(".e_box .e_droplist").off("click").on("click",["li","input",".shape"],function(t){t.stopPropagation(),window.e=t;var e=u(this).closest(".p_selectC"),a=(u(this),u(this).closest(".e_box")),i=a.find(".e_droplist"),r=a.find(".shape"),n=i.find(".itembox"),s=t.target.tagName.toLowerCase(),o=function(){r.removeClass("clicked"),n.addClass("item_hide"),a.css({overflow:"hidden"}),i.removeClass("hover"),u(document).off("click")};if("input"===s||u(t.target).hasClass("shape"))return t.stopPropagation(),r.hasClass("clicked")?o():(r.addClass("clicked"),n.removeClass("item_hide"),a.css({overflow:"visible"}),i.addClass("hover"),u(document).on("click",o)),!1;var d=u(t.target).closest("li"),c=d.text().trim(),p=d.attr("idx");i.find("input").val(c),a.find("input.d_select").val(p).data("status",1),e.removeClass("error").addClass("success"),o()}),m.find(".e_box").off("click").on("click",".e_checkbox",function(t){var e=u(this).closest(".e_box");0<e.find("input[type='checkbox']:checked").length?e.find("input").data("status",1):e.find("input").data("status",0)}),m.on("blur",".InputText:visible",function(){s(u(this))}),m.find("input[type='radio']").data("status",1);var n,o,r;o=l,(r=(n=m).find(".p_sendBtn")).off("click"),r.each(function(){u(this).on("click",function(){var r=u(this),t="";t=u(this).hasClass("mailBtn")?u(this).parent().parents(".p_aaa").find(".p_EmailBox"):u(this).parent().parents(".p_aaa").find(".p_PhoneBox");var e={compType:o.id,verifyType:"SMS",verifyName:t.find("input").val()};return u(this).hasClass("mailBtn")&&(e.verifyType="EMAIL"),(!t.find(".corlor_warning .color_error")||""==t.find(".corlor_warning .color_error").text())&&(""==t.find("input").val()?(t.find("input").trigger("blur"),!1):void x(n,o,"/interactionApi/member/account/sendVerify",e,"GET",function(t){if(t.data&&""!==t.data){var e=JSON.parse(t.data);if("101"==e.status){var a=60;r.attr("disabled",!0),r.parent().next().removeClass("item_hide");var i=setInterval(function(){r.parent().next().find("span").text(--a),a<0&&(a=60,r.removeAttr("disabled"),r.parent().next().addClass("item_hide"),r.parent().next().find("span").text(a),clearInterval(i))},1e3)}else y(r.parent(),r.parent().prev(),e.msg)}}))})});var d=function(t,e,a){if(!(0<e.find("input[name=captchas]").length)||e.find("input[name=captchas]").val())if(t.data&&""!==t.data){var i=JSON.parse(t.data);if("101"==i.status){var r=i.data;"1"==r.code?(u.message({type:"success",msg:a.success}),setTimeout(function(){var t=a.submitUrl,e=a.submitTarget;""==t?window.location.reload():"_blank"==e?window.open(t):window.location.href=t},500)):"-3"==r.code?u.message({type:"error",msg:a.submitRepeat}):u.message({type:"error",msg:a.submitError})}else u.message({type:"error",msg:a.submitError})}else u.message({type:"error",msg:a.submitError})},c=!0,p=!0,f=!0;m.off("click",".p_submit"),m.on("click",".p_submit",function(){m.find(".p_LoginPrompt").remove();var r={},n={compId:l.id};m.find(".p_itemBox").length,m.find(".InputText:visible").each(function(){var t=u(this).parent(),e=u(this).attr("name");if(e){var a=u(this).attr("tit"),i=u(this).val();n[e]=i,f=""!=i?(r[e]=i,s(u(this)),p=!0):("true"==u(this).attr("data-required")&&(r[e]=u(this).data("status"),y(u(this),t,a+l.mp)),!(p=!1))}}),m.find(".p_SectorBox").each(function(){var e=u(this).siblings(".p_selectC"),a=u(this).attr("tit"),i=u(this).find("select.InputText");i.each(function(){var t=u(this).parent().prev().attr("name");f="请选择"!=u(this).val()?(r[t]=i.map(function(){return u(this).val()}).get().join(","),!0):(y(u(this),e,a+l.mp),!1)})}),m.find(".p_GenderBox").each(function(){var e=u(this).find("input[type='radio']:checked");"true"==u(this).find('input[type="hidden"]').attr("data-required")?p&&0==e.length&&(u.message({msg:l.CorrectRequired,type:"error"}),p=!1):u(this).find("input[type='radio']").each(function(){var t=u(this).attr("name");u(this).prop("checked")&&(r[t]=e.map(function(){return u(this).val()}).get().join(","),c=0!=e.length)})}),m.find(".p_checkboxContainerBox").each(function(){var e=u(this).find("input[type='checkbox']:checked");"true"==u(this).find('input[type="hidden"]').attr("data-required")?p&&0==e.length&&(u.message({msg:l.CorrectRequired,type:"error"}),p=!1):u(this).find("input[type='checkbox']").each(function(){var t=u(this).attr("name");u(this).prop("checked")&&(r[t]=e.map(function(){return u(this).val()}).get().join(","),p=0!=e.length)})}),r.selectId=l.selectId,r.messageId=m.find("#categoryId").val(),r.captchas=m.find("input[name=captchas]").val(),r.captchaId=m.find(".p_image img").attr("data-id"),0!=m.find("input[name=captchas]").length||null!=r.captchas&&"undefined"!=r.captchas||(g=!0),m.find(".InputText").each(function(){var t=u(this);"phoneCode"!=t.attr("name")&&"mailCode"!=t.attr("name")||s(t)}),0==[].length&&p&&f&&g&&c&&v&&x(m,l,"/interactionApi/message/add",{formData:r},"POST",d)})}}});